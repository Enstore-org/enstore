#!/bin/sh
set -u  # force better programming and ability to use check for not set
if [ "${1:-}" = "-x" ] ; then set -xv; shift; fi

# Starts enstore after a machine boots

timeout=10
output=/home/enstore/`hostname`.startup
estat=0

case "$1" in

  start)
        echo Starting enstore 2>&1 | tee /dev/console >>$output

	find /tmp/enstore -name "*pids" -exec rm {} \;
	find /tmp/enstore -name "trace*key" -exec rm {} \;

        . /usr/local/etc/setups.sh
        setup enstore 

        n1=`echo $ENSTORE_CONFIG_HOST | sed -e 's/\.fnal\.gov//'`
        n2=`uname -n | sed -e 's/\.fnal\.gov//'`
        if [ "$n1" != "$n2" ]; then
          for server in config log alarm; do
            enstore $server --alive --timeout=$timeout 2>&1 | tee /dev/console >>$output
            estat=$?
            if [ $estat -ne 0 ] ; then
              echo "`date`: $server not responding, can not continue..." 2>&1 | tee /dev/console >>$output
              break
            fi
          done
        fi
        if [ $estat -eq 0 ]; then
        # we should be enstore when we start this up (at least not root)
        if [ "`whoami`" = "root" ] ; then
            su enstore -c ". /usr/local/etc/setups.sh ; setup enstore; enstore Estart $n2" ; fi
        else
            enstore Estart $n2 
        fi
        ;;

  stop)
        echo Stopping enstore 2>&1 | tee /dev/console >>$output
        . /usr/local/etc/setups.sh
        setup enstore
        enstore stop
        ;;

  install)
        . /usr/local/etc/setups.sh
        setup enstore
        #set -xv
        x=/etc/rc.d/init.d/enstore-boot
        rm -f $x; cp $ENSTORE_DIR/bin/enstore-boot $x
        cd /etc/rc.d/rc3.d
        x=S99zzzenstore-boot
        rm -f $x; ln -s ../init.d/enstore-boot $x
        cd /etc/rc.d/rc6.d
        x=K01aaaenstore-boot
        rm -f $x; ln -s ../init.d/enstore-boot $x
        ;;
  *)
        echo "Usage: /etc/rc.d/init.d/enstore-boot {start|stop}"
        estat=1
        ;;
esac

exit $estat
