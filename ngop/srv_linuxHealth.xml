<MA-config Update="180" Name="LinuxHealthAgent">
   <NCS Heartbeat="300" Port="19997" Host="ngopsrv"/>
      <DaemonList Name="SystemDaemon">
        <Daemon Name="syslogd"/>
        <Daemon Name="inetd"/>
        <Daemon Name="crond"/>
   </DaemonList>
   <DiskList Name="SystemDisk">
         <Disk Name="/home"/>
         <Disk Name="/diska"/>
         <Disk Name="/diskb"/>
         <Disk Name="/diskc"/>
   </DiskList>
      <System Name="OSHealth" Cluster="localhost">
          <MonitoredElement Name="cpuLoad" Host="localhost" Type="sysUsage">
          <ConditionSet>
                <fn Name="plug_ins" Arg="python /var/ngop/include/checkCpuLoad.py" RetVal="float:cpuLoad"/>
   	  <Condition State="0" SevLevel="0" Description="Average cpu load during last 15 min exceeds 5">
    		<apply>
       		<geq/>
         	<ci>cpuLoad</ci>
         	<cn>5.0</cn>
    		</apply>
          <Action ID="enstore_alarm" Host="localhost" Type="local">
	         <Exec Name="/var/ngop/include/raise_enstore_alarm" Argument="%Description" />
          </Action>
       	  </Condition>
          <Condition State="1" SevLevel="6" Description="Average cpu load is between 4 and 5 during last 15 min">
                <apply>
		<and/>
		<apply>
                  <geq/>
                  <ci>cpuLoad</ci>
                  <cn>4.0</cn>
                </apply>
                <apply>
                  <lt/>
                  <ci>cpuLoad</ci>
                  <cn>5.0</cn>
                </apply>
		</apply>
          <Action ID="enstore_alarm" Host="localhost" Type="local">
	         <Exec Name="/var/ngop/include/raise_enstore_alarm" Argument="%Description" />
          </Action>
          </Condition>
          <Condition State="1" SevLevel="4" Description="Average cpu load is between 3 and 4 during last 15 min">
                <apply>
		<and/>
		<apply>
                  <geq/>
                  <ci>cpuLoad</ci>
                  <cn>3.0</cn>
                </apply>
                <apply>
                  <lt/>
                  <ci>cpuLoad</ci>
                  <cn>4.0</cn>
                </apply>
		</apply>
          <Action ID="enstore_alarm" Host="localhost" Type="local">
	         <Exec Name="/var/ngop/include/raise_enstore_alarm" Argument="%Description" />
          </Action>
          </Condition>
         </ConditionSet>
    </MonitoredElement>
    
        <MonitoredElement Name="Memory" Host="localhost" Type="sysUsage">
           <ConditionSet>
		<fn Name="plug_ins" Arg="free -o|grep Mem:|awk '{print $2} {print $3} {print $6} {print $7}' " RetVal="float:total,float:used,float:buffers,float:cached"/>
   		<Condition State="0" SevLevel="0" Description="Memory utilization exceeds 99%">
    		<apply>	
       		  <gt/>
		  <apply>
	  	   <divide/>
	  	   <apply>
	   		<minus/>
	   		<ci>used</ci>
	   		<ci>cached</ci>
           		<ci>buffers</ci>
	          </apply>
	          <ci>total</ci>
                 </apply>
         	 <cn>0.99</cn>
    		</apply>
                <Action ID="enstore_alarm" Host="localhost" Type="local">
	              <Exec Name="/var/ngop/include/raise_enstore_alarm" Argument="%Description" />
                </Action>
    		</Condition>
	   </ConditionSet>
        </MonitoredElement>
  	<MonitoredElement Name="Swap" Host="localhost" Type="sysUsage">
            <ConditionSet>
        	<fn Name="plug_ins" Arg="free -o|grep Swap:|awk '{print $2} {print $3} '" RetVal="float:total,float:used"/>
   		<Condition State="0" SevLevel="0" Description="Swap utilization exceeds 30%">
    		<apply>
       		<gt/>
        	   <apply>
                  	<divide/>
           		<ci>used</ci>
           		<ci>total</ci>
        	   </apply>
         	   <cn>0.30</cn>
    		</apply>
                <Action ID="enstore_alarm" Host="localhost" Type="local">
	               <Exec Name="/var/ngop/include/raise_enstore_alarm" Argument="%Description" />
                </Action>
    		</Condition>
   		<Condition State="1" SevLevel="6" Description="Swap utilization between 20 and 30%">
    		<apply>
		<and/>
		 <apply>
       		 <geq/>
        	   <apply>
                  	<divide/>
           		<ci>used</ci>
           		<ci>total</ci>
        	   </apply>
         	   <cn>0.20</cn>
    		 </apply>
		 <apply>
       		 <lt/>
        	   <apply>
                  	<divide/>
           		<ci>used</ci>
           		<ci>total</ci>
        	   </apply>
         	   <cn>0.30</cn>
    		 </apply>
		</apply>
                <Action ID="enstore_alarm" Host="localhost" Type="local">
	                <Exec Name="/var/ngop/include/raise_enstore_alarm" Argument="%Description" />
                </Action>
    		</Condition>
         </ConditionSet>
    </MonitoredElement>
    <For Each="Disk" In="DiskList" Name="SystemDisk" Var="{%Var}">
 	   <MonitoredElement Name="{%Var}" Host="localhost" Type="FileSystem">
		<ConditionSet>
                   <fn Name="plug_ins" Arg="python /var/ngop/include/checkDisk.py {%Var}" RetVal="int:size"/>
                   <Condition State="-2" SevLevel="0" Description="{%Var} not mounted">
                     <apply>
                      <eq/>
                      <ci>size</ci>
                      <cn>-1</cn>
                     </apply>
                  </Condition>
		   <Condition State="1" SevLevel="6" Description="{%Var} between 85 and 95%">	
    		    <apply>
		     <and/>
		     <apply>
                      <geq/>
                      <ci>size</ci>
                      <cn>85</cn>
                     </apply>
		     <apply>
                      <lt/>
                      <ci>size</ci>
                      <cn>95</cn>
                     </apply>
		    </apply>		
                    <Action ID="enstore_alarm" Host="localhost" Type="local">
	                <Exec Name="/var/ngop/include/raise_enstore_alarm" Argument="%Description" />
                    </Action>
   		   </Condition>	
		   <Condition State="0" SevLevel="0" Description="{%Var} size exceeds 95%">	
    		    <apply>
                      <geq/>
                      <ci>size</ci>
                      <cn>95</cn>
		    </apply>
                   <Action ID="enstore_alarm" Host="localhost" Type="local">
	                  <Exec Name="/var/ngop/include/raise_enstore_alarm" Argument="%Description" />
                   </Action>
   		   </Condition>
	 	</ConditionSet>
    	    </MonitoredElement>   
    </For>
    <For Each="Daemon" In="DaemonList" Var="{%Var}" Name="SystemDaemon">
        <MonitoredElement Name="{%Var}" Host="localhost" Type="Daemon">
        <ConditionSet>
        <fn Name="plug_ins" Arg="cat /proc/[0-9]*/stat|grep \(*{%Var}\)|wc -l" RetVal="int:alive"/>
   	<Condition State="0" SevLevel="0" Description="{%Var} is dead">
    	<apply>
       	<eq/>
         <ci>alive</ci>
         <cn>0</cn>
    	</apply>
          <Action ID="enstore_alarm" Host="localhost" Type="local">
	         <Exec Name="/var/ngop/include/raise_enstore_alarm" Argument="%Description" />
          </Action>
    	</Condition>
	</ConditionSet>
    	</MonitoredElement>
    </For>
    <MonitoredElement Name="timeSync" Host="localhost" Type="Daemon">
        <ConditionSet>
        <fn Name="plug_ins" Arg="python /var/ngop/include/checkTime.py 4 60.0" RetVal="int:isSync"/>
    	<Condition State="1" SevLevel="6" Description="Time is not syncronized (more then 1 minute off) for more than 4 hours">
        <apply>
       	<eq/>
         <ci>isSync</ci>
         <cn>0</cn>
    	</apply>
          <Action ID="enstore_alarm" Host="localhost" Type="local">
	         <Exec Name="/var/ngop/include/raise_enstore_alarm" Argument="%Description" />
          </Action>
    	</Condition>       
    	<Condition State="0" SevLevel="0" Description="xntpd is dead">
        <apply>
       	<eq/>
         <ci>isSync</ci>
         <cn>-2</cn>
    	</apply>
          <Action ID="enstore_alarm" Host="localhost" Type="local">
	         <Exec Name="/var/ngop/include/raise_enstore_alarm" Argument="%Description" />
          </Action>
    	</Condition>       
    	<Condition State="-1" SevLevel="0" Description="can not obtain information">
        <apply>
       	<eq/>
         <ci>isSync</ci>
         <cn>-3</cn>
    	</apply>
    	</Condition>    
	</ConditionSet>
    	</MonitoredElement>
</System>

       <System Name="Hardware" Cluster="localhost">
      <MonitoredElement Name="numProcessors" Host="localhost" Type="Hardware">
         <ConditionSet>
         <fn Name="plug_ins" Arg="cat /proc/cpuinfo|grep processor|wc -l" RetVal="int:numPr"/>
         <Condition State="1" SevLevel="6" Description="Missing one processor">
            <apply>
	          <eq/>
                  <ci>numPr</ci>
                  <cn>1</cn>
            </apply>
          <Action ID="enstore_alarm" Host="localhost" Type="local">
	         <Exec Name="/var/ngop/include/raise_enstore_alarm" Argument="%Description" />
          </Action>
	</Condition>
        <Condition State="0" SevLevel="0" Description="No processor info found in cpuinfo">
            <apply>
                  <eq/>
                  <ci>numPr</ci>
                  <cn>0</cn>
            </apply>
          <Action ID="enstore_alarm" Host="localhost" Type="local">
	         <Exec Name="/var/ngop/include/raise_enstore_alarm" Argument="%Description" />
          </Action>
         </Condition>
        </ConditionSet>
       </MonitoredElement>
       <MonitoredElement Name="baseTemp" Host="localhost" Type="Hardware">
         <ConditionSet>
         <fn Name="plug_ins" Arg="./usr/local/etc/setups.sh;setup ipmi;python /var/ngop/include/checkSensor.py temp" RetVal="int:mask1,int:mask2"/>
         <Condition State="1" SevLevel="6" Description="Temperature is above non-critical threshold">
            <apply>
            <or/>
            <apply>
            <eq/>
             <ci>mask1</ci>
             <cn>4</cn>
            </apply>
            <apply>
            <eq/>
            <ci>mask2</ci>
            <cn>4</cn>
            </apply>
            </apply>
          <Action ID="enstore_alarm" Host="localhost" Type="local">
	         <Exec Name="/var/ngop/include/raise_enstore_alarm" Argument="%Description" />
          </Action>
	</Condition>
         <Condition State="0" SevLevel="0" Description="Temperature is above critical threshold">
            <apply>
            <or/>
            <apply>
            <eq/>
             <ci>mask1</ci>
             <cn>1</cn>
            </apply>
            <apply>
            <eq/>
            <ci>mask2</ci>
            <cn>1</cn>
            </apply>
            <apply>
            <eq/>
             <ci>mask1</ci>
             <cn>5</cn>
            </apply>
            <apply>
            <eq/>
            <ci>mask2</ci>
            <cn>5</cn>
            </apply>
            </apply>
          <Action ID="enstore_alarm" Host="localhost" Type="local">
	         <Exec Name="/var/ngop/include/raise_enstore_alarm" Argument="%Description" />
          </Action>
	</Condition>

	<Condition State="-1" SevLevel="0" Description="Temperature is unknown">
            <apply>
            <or/>
            <apply>
                <eq/>
                <ci>mask1</ci>
                <cn>-1</cn>
              </apply>
            <apply>
                <eq/>
                <ci>mask2</ci>
                <cn>-1</cn>
              </apply>
              </apply>
        </Condition>
        </ConditionSet>
       </MonitoredElement>
       <MonitoredElement Name="fanSpeed" Host="localhost" Type="Hardware">
         <ConditionSet>
         <fn Name="plug_ins" Arg="./usr/local/etc/setups.sh;setup ipmi;python /var/ngop/include/checkSensor.py fan" RetVal="float:speed1,float:speed2"/>
         <Condition State="0" SevLevel="0" Description="Fan Speed is below 3000">
            <apply>
            <or/>
	    <apply>
	      <and/>
              <apply>
                <lt/>
                <ci>speed1</ci>
                <cn>3000</cn>
              </apply>         
 	      <apply>
                <geq/>
                <ci>speed1</ci>
                <cn>0</cn>
              </apply>
            </apply>
            <apply>
              <apply>
                <and/>
		<apply>		
            		<lt/>
            		<ci>speed2</ci>
            		<cn>3000</cn>
            	</apply>
 	      	<apply>
                	<geq/>
                	<ci>speed1</ci>
                	<cn>0</cn>
              	</apply>
            </apply>
           </apply> 
  </apply> 
          <Action ID="enstore_alarm" Host="localhost" Type="local">
	         <Exec Name="/var/ngop/include/raise_enstore_alarm" Argument="%Description" />
          </Action>
	</Condition>
         <Condition State="-1" SevLevel="0" Description="Fan Speed is unknown">
            <apply>
            <or/>
            <apply>
                <eq/>
                <ci>speed1</ci>
                <cn>-1</cn>
              </apply>
            <apply>
                <eq/>
                <ci>speed2</ci>
                <cn>-1</cn>
              </apply>
              </apply>
	</Condition>
        </ConditionSet>
       </MonitoredElement>
       <MonitoredElement Name="firmware" Host="localhost" Type="Hardware">
         <ConditionSet>
         <fn Name="plug_ins" Arg="./usr/local/etc/setups.sh;setup ipmi;python /var/ngop/include/checkSensor.py firmware" RetVal="int:down,str:reason"/>
         <Condition State="0" SevLevel="0" Description="Firmware has to be reloaded">
            <apply>
                <eq/>
                <ci>down</ci>
                <cn>2</cn>
           </apply>
          <Action ID="enstore_alarm" Host="localhost" Type="local">
	         <Exec Name="/var/ngop/include/raise_enstore_alarm" Argument="%Description" />
          </Action>
        </Condition>
         <Condition State="0" SevLevel="0" Description="ipmisrv  has to be restarted">
            <apply>
                <eq/>
                <ci>down</ci>
                <cn>1</cn>
           </apply>
          <Action ID="enstore_alarm" Host="localhost" Type="local">
	         <Exec Name="/var/ngop/include/raise_enstore_alarm" Argument="%Description" />
          </Action>
        </Condition>
        </ConditionSet>
       </MonitoredElement>


	</System>
</MA-config>
